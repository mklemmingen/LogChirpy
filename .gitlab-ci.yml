image: ruby:2.7-slim

variables:
  GIT_DEPTH: 0

stages:
  - deploy

deploy-logchirpy:
  stage: deploy
  before_script:
    - apt-get update && apt-get install -y git
  script:
    - echo "Writing deployment script..."
    - |
      cat <<'EOF' > run-deploy.sh
      #!/bin/bash
      set -e

      echo "Starting deploy..."

      git config --global user.name "mklemmingen"
      git config --global user.email "mklemmingen@users.noreply.github.com"

      git remote remove origin || true
      git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/mklemmingen/LogChirpy.git

      echo "Fetching main branch..."
      git fetch origin main
      git checkout main

      KEEP_COMMIT=$(git rev-list --reverse --since="2025-04-12T00:00:00" main | head -n 1)
      echo "Keeping commits from: \$KEEP_COMMIT"

      if [ -z "\$KEEP_COMMIT" ]; then
        echo "No commits found from April 12, 2025 onward."
        exit 1
      fi

      echo "Keeping commits from: $KEEP_COMMIT"
      git checkout --detach "$KEEP_COMMIT"
      git checkout -B main
      git rebase --root --onto "$KEEP_COMMIT"^


      echo "Sanitizing email..."
      git filter-branch --env-filter '
        OLD_EMAIL="martin.lauterbach@student.reutlingen-university.de"
        CORRECT_NAME="mklemmingen"
        CORRECT_EMAIL="mklemmingen@users.noreply.github.com"

        if [ "\$GIT_COMMITTER_EMAIL" = "\$OLD_EMAIL" ]; then
            export GIT_COMMITTER_NAME="\$CORRECT_NAME"
            export GIT_COMMITTER_EMAIL="\$CORRECT_EMAIL"
        fi
        if [ "\$GIT_AUTHOR_EMAIL" = "\$OLD_EMAIL" ]; then
            export GIT_AUTHOR_NAME="\$CORRECT_NAME"
            export GIT_AUTHOR_EMAIL="\$CORRECT_EMAIL"
        fi
      ' --tag-name-filter cat -- --branches --tags

      echo "Pushing to GitHub..."
      if git push --force origin main; then
        echo "✅ Push successful"
      else
        echo "❌ Push failed"
        exit 1
      fi

      echo "LogChirpy deployed."
      EOF
    - chmod +x run-deploy.sh
    - ./run-deploy.sh
  only:
    - main
  environment: production
